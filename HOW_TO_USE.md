# Numa Log - คู่มือการใช้งาน

Numa Log เป็นเว็บแอปพลิเคชันสำหรับบันทึกและวิเคราะห์ข้อมูลการซื้อสินค้า (Merchandise) ของไอดอล พัฒนาด้วย PHP 8.2, SQLite, Bootstrap 5 และ Chart.js

---

## สารบัญ

1. [การติดตั้ง](#1-การติดตั้ง)
2. [การเข้าสู่ระบบ](#2-การเข้าสู่ระบบ)
3. [จัดการรายการสินค้า](#3-จัดการรายการสินค้า-itemsindexphp)
4. [รายงาน](#4-รายงาน-reportphp)
5. [จัดการข้อมูลไอดอล](#5-จัดการข้อมูลไอดอล-idolsphp)
6. [จัดการประเภทสินค้า](#6-จัดการประเภทสินค้า-typesphp)
7. [จัดการผู้ใช้งาน](#7-จัดการผู้ใช้งาน-usersphp)
8. [สำรองและกู้คืนข้อมูล](#8-สำรองและกู้คืนข้อมูล-backupphp)
9. [นำเข้าข้อมูลจาก Excel](#9-นำเข้าข้อมูลจาก-excel)
10. [การตั้งค่า](#10-การตั้งค่า)

---

## 1. การติดตั้ง

### วิธีที่ 1: Docker (แนะนำ)

```bash
# เริ่มต้นใช้งาน
docker compose up -d

# เปิดเบราว์เซอร์ไปที่
http://localhost:8080
```

**เปลี่ยน Port:** แก้ไขไฟล์ `docker-compose.yml` ที่ `ports: "8080:80"` เป็น port ที่ต้องการ

**คำสั่งจัดการ Docker:**

| คำสั่ง | คำอธิบาย |
|--------|----------|
| `docker compose up -d` | เริ่มระบบ |
| `docker compose down` | หยุดระบบ |
| `docker compose logs -f` | ดู log |
| `docker compose up -d --build` | สร้างใหม่หลังแก้โค้ด |
| `docker compose down -v` | ลบทุกอย่างรวมข้อมูล (ระวัง!) |

### วิธีที่ 2: Manual (XAMPP)

```bash
# 1. Clone โปรเจกต์
git clone <repository-url>
cd numa-log

# 2. ติดตั้ง dependencies
composer install

# 3. วางโปรเจกต์ไว้ใน htdocs ของ XAMPP
# C:\xampp\htdocs\numa-log\

# 4. เปิดเบราว์เซอร์
http://localhost/numa-log/
```

ฐานข้อมูล SQLite จะถูกสร้างอัตโนมัติเมื่อเปิดใช้งานครั้งแรก

---

## 2. การเข้าสู่ระบบ

### ข้อมูลเข้าสู่ระบบเริ่มต้น

| Username | Password | Role |
|----------|----------|------|
| `admin` | `admin` | Admin |

> **สำคัญ:** ควรเปลี่ยนรหัสผ่านทันทีหลังเข้าสู่ระบบครั้งแรก ผ่านหน้า Users

### สิทธิ์ของแต่ละ Role

| ฟีเจอร์ | Admin | User |
|---------|:-----:|:----:|
| ดู/เพิ่ม/แก้ไข/ลบ รายการสินค้า | ✅ | ✅ |
| ดูรายงาน | ✅ | ✅ |
| จัดการข้อมูลไอดอล | ✅ | ✅ |
| จัดการประเภทสินค้า | ✅ | ✅ |
| เปลี่ยนรหัสผ่านตัวเอง | ✅ | ✅ |
| นำเข้าข้อมูล Excel | ✅ | ❌ |
| สำรอง/กู้คืนข้อมูล | ✅ | ❌ |
| จัดการผู้ใช้งาน | ✅ | ❌ |
| Re-seed ข้อมูลไอดอล | ✅ | ❌ |

---

## 3. จัดการรายการสินค้า (Items/index.php)

หน้าหลักสำหรับบันทึกข้อมูลการซื้อสินค้าไอดอล

### เพิ่มรายการใหม่

1. กดปุ่ม **"Add Item"** ด้านบน
2. กรอกข้อมูลในฟอร์ม:
   - **Order Date** - วันที่สั่งซื้อ
   - **Event Date** - วันที่งาน/อีเวนต์
   - **Title** - ชื่อสินค้า
   - **Idol** - ชื่อไอดอล/กลุ่ม (พิมพ์เพื่อค้นหาจาก dropdown)
   - **Type** - ประเภทสินค้า (พิมพ์เพื่อค้นหาจาก dropdown)
   - **Price per Qty** - ราคาต่อชิ้น
   - **Qty** - จำนวน
3. กดปุ่ม **"Save"**

### แก้ไขรายการ

1. กดปุ่ม **แก้ไข** (ไอคอนดินสอ) ที่แถวรายการที่ต้องการ
2. แก้ไขข้อมูลในฟอร์ม
3. กดปุ่ม **"Save"**

### Clone (ทำซ้ำ) รายการ

1. กดปุ่ม **Clone** (ไอคอน copy) ที่แถวรายการที่ต้องการ
2. ระบบจะสร้างรายการใหม่ที่มีข้อมูลเหมือนเดิมทุกอย่าง
3. แก้ไขข้อมูลตามต้องการ แล้วกด **"Save"**

### ลบรายการ

1. กดปุ่ม **ลบ** (ไอคอนถังขยะ) ที่แถวรายการที่ต้องการ
2. ยืนยันการลบ

### การกรองและค้นหา

ใช้ตัวกรองด้านบนตารางเพื่อค้นหารายการ:

| ตัวกรอง | คำอธิบาย |
|---------|----------|
| **Idol** | กรองตามชื่อไอดอล/กลุ่ม |
| **Type** | กรองตามประเภทสินค้า |
| **Date Range** | กรองตามช่วงวันที่ |
| **Search** | ค้นหาจากชื่อสินค้า |

### การเรียงลำดับ

- คลิกที่หัวคอลัมน์ในตารางเพื่อเรียงลำดับ (คลิกซ้ำเพื่อสลับ ascending/descending)

### Summary Cards

ด้านบนของตารางจะแสดงสรุปข้อมูล:
- **จำนวนรายการทั้งหมด** (Total Items)
- **จำนวนชิ้นทั้งหมด** (Total Quantity)
- **ยอดใช้จ่ายทั้งหมด** (Total Spending)

---

## 4. รายงาน (report.php)

หน้ารายงานมี 5 แท็บ แต่ละแท็บแสดงข้อมูลในมุมมองที่แตกต่างกัน:

### 4.1 Monthly (รายเดือน)

- แสดงกราฟแท่ง (ยอดใช้จ่าย) + เส้น (จำนวน) แยกตามเดือน
- **คลิกที่เดือนใดก็ได้** เพื่อดูรายละเอียดรายวันในเดือนนั้น

### 4.2 By Member (ตามสมาชิก)

- แสดงอันดับสมาชิกไอดอลตามยอดใช้จ่าย
- **คลิกที่ชื่อสมาชิก** เพื่อดูรายละเอียด:
  - สัดส่วนตามประเภทสินค้า
  - กราฟยอดใช้จ่ายรายเดือน

### 4.3 By Group (ตามกลุ่ม/ยูนิต)

- แสดงยอดใช้จ่ายรวมของแต่ละกลุ่ม/ยูนิต
- **คลิกเพื่อขยาย** ดูรายละเอียดสมาชิกในกลุ่ม

### 4.4 By Company (ตามค่าย)

- แสดงยอดใช้จ่ายรวมของแต่ละค่าย
- **คลิกเพื่อขยาย** ดูกลุ่มภายใต้ค่ายนั้น

### 4.5 By Type (ตามประเภทสินค้า)

- แสดงอันดับประเภทสินค้าตามยอดใช้จ่าย
- แสดงจำนวนรายการและจำนวนชิ้นของแต่ละประเภท

---

## 5. จัดการข้อมูลไอดอล (idols.php)

จัดการโครงสร้างลำดับชั้นของไอดอล: **ค่าย > กลุ่ม/ยูนิต > สมาชิก**

### เพิ่มข้อมูลไอดอล

1. กดปุ่ม **"Add Entity"**
2. กรอกข้อมูล:
   - **Name** - ชื่อ
   - **Category** - ประเภท (`company`, `group`, `unit`, `member`)
   - **Parent** - สังกัด (เช่น สมาชิกอยู่ใต้กลุ่มไหน)
   - **Sort Order** - ลำดับการแสดงผล
3. กดปุ่ม **"Save"**

### โครงสร้างลำดับชั้น

```
Company (ค่าย)
  └── Group / Unit (กลุ่ม / ยูนิต)
        └── Member (สมาชิก)
```

### Unmapped Names (ชื่อที่ยังไม่ได้จัดกลุ่ม)

- ระบบจะตรวจจับชื่อ Idol ในรายการสินค้าที่ยังไม่มีใน idol_entities
- แสดงเป็นรายการพร้อมปุ่ม **Quick Add** เพื่อเพิ่มเข้าระบบอย่างรวดเร็ว

### สถิติ

แต่ละ entity จะแสดง:
- จำนวนรายการ (Items)
- ยอดใช้จ่ายรวม (Spending)

---

## 6. จัดการประเภทสินค้า (types.php)

### เพิ่มประเภทสินค้า

1. กดปุ่ม **"Add Type"**
2. กรอกข้อมูล:
   - **Name** - ชื่อประเภท (เช่น Photocard, T-Shirt, Lightstick)
   - **Description** - คำอธิบาย
   - **Sort Order** - ลำดับการแสดงผล
3. กดปุ่ม **"Save"**

### สถิติการใช้งาน

แต่ละประเภทจะแสดง:
- จำนวนแถว (Rows) ที่ใช้ประเภทนี้
- จำนวนชิ้น (Quantity) รวม
- ยอดใช้จ่ายรวม (Spending)

### Unmapped Type Names

- ระบบจะตรวจจับชื่อ Type ในรายการสินค้าที่ยังไม่มีใน type_categories
- แสดงเป็นรายการพร้อมปุ่ม **Quick Add**

---

## 7. จัดการผู้ใช้งาน (users.php)

> เฉพาะ Admin เท่านั้น (ยกเว้นการเปลี่ยนรหัสผ่านตัวเอง)

### สร้างผู้ใช้ใหม่

1. กดปุ่ม **"Add User"**
2. กรอกข้อมูล:
   - **Username** - ชื่อผู้ใช้สำหรับเข้าสู่ระบบ
   - **Password** - รหัสผ่าน
   - **Display Name** - ชื่อที่แสดง
   - **Role** - สิทธิ์ (`admin` หรือ `user`)
3. กดปุ่ม **"Save"**

### เปลี่ยนรหัสผ่าน

- ผู้ใช้ทุกคนสามารถเปลี่ยนรหัสผ่านของตัวเองได้
- กดปุ่ม **"Change Password"** ที่ชื่อของตัวเอง

---

## 8. สำรองและกู้คืนข้อมูล (backup.php)

> เฉพาะ Admin เท่านั้น

### สร้าง Backup

1. ไปที่หน้า **Backup**
2. กรอกชื่อ label สำหรับ backup (ไม่บังคับ)
3. กดปุ่ม **"Create Backup"**

### กู้คืนข้อมูล (Restore)

1. เลือก backup ที่ต้องการกู้คืน
2. กดปุ่ม **"Restore"**
3. ยืนยันการกู้คืน

> ระบบจะสร้าง backup อัตโนมัติก่อนทำการ restore ทุกครั้ง เพื่อป้องกันข้อมูลสูญหาย

### Download / Upload Backup

- **Download** - ดาวน์โหลดไฟล์ backup เพื่อเก็บไว้ในเครื่อง
- **Upload** - อัปโหลดไฟล์ backup ที่เคยดาวน์โหลดไว้กลับเข้าระบบ

### ลบ Backup

- กดปุ่ม **"Delete"** ที่ backup ที่ต้องการลบ

---

## 9. นำเข้าข้อมูลจาก Excel

> เฉพาะ Admin เท่านั้น | ต้องเปิดใช้งานใน config ก่อน

### เปิดใช้งาน Import

แก้ไขไฟล์ `config.php`:

```php
define('ALLOW_IMPORT', true);
```

### วิธีนำเข้า

1. เตรียมไฟล์ `.xlsx` ที่มีข้อมูลตามรูปแบบ:
   - คอลัมน์: Order Date, Event Date, Title, Idol, Type, Price per Qty, Qty
2. กดปุ่ม **"Import Excel"** ที่หน้า Items
3. เลือกไฟล์ `.xlsx`
4. ยืนยันการนำเข้า

> **ระวัง:** การ Import จะ**ลบข้อมูลเดิมทั้งหมด**ก่อนนำเข้าข้อมูลใหม่ ควรสำรองข้อมูลก่อน!

---

## 10. การตั้งค่า

การตั้งค่าทั้งหมดอยู่ในไฟล์ `config.php`:

| ค่า | ค่าเริ่มต้น | คำอธิบาย |
|-----|------------|----------|
| `ALLOW_IMPORT` | `false` | เปิด/ปิดปุ่ม Import Excel |
| `ALLOW_RESEED` | `false` | เปิด/ปิดปุ่ม Re-seed ข้อมูลไอดอล |
| `AUTH_ENABLED` | `true` | เปิด/ปิดระบบ Login |
| `SESSION_LIFETIME` | `86400` | อายุ session (วินาที) ค่าเริ่มต้น = 24 ชั่วโมง |

### ปิดระบบ Login (ใช้งานส่วนตัว/development)

```php
define('AUTH_ENABLED', false);
```

### เปิดใช้งาน Import และ Re-seed

```php
define('ALLOW_IMPORT', true);   // แสดงปุ่ม Import Excel
define('ALLOW_RESEED', true);   // แสดงปุ่ม Re-seed ในหน้า Idols
```

---

## เทคโนโลยีที่ใช้

| ส่วน | เทคโนโลยี |
|------|-----------|
| Backend | PHP 8.2, PDO/SQLite |
| Frontend | Bootstrap 5.3.3, Bootstrap Icons 1.11.3 |
| กราฟ | Chart.js 4.4.7 |
| นำเข้า Excel | PhpSpreadsheet |
| ฐานข้อมูล | SQLite (WAL mode) |
| Container | Docker & Docker Compose |
